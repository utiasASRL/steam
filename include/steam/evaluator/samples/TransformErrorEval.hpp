//////////////////////////////////////////////////////////////////////////////////////////////
/// \file TransformErrorEval.hpp
///
/// \author Sean Anderson, ASRL
//////////////////////////////////////////////////////////////////////////////////////////////

#ifndef STEAM_TRANSFORM_ERROR_EVALUATOR_HPP
#define STEAM_TRANSFORM_ERROR_EVALUATOR_HPP

// #include <steam.hpp>
// #include <steam/evaluator/samples/TransformErrorEval.hpp>
#include <steam/evaluator/ErrorEvaluator.hpp>
#include <steam/evaluator/blockauto/transform/TransformEvalOperations.hpp>

namespace steam {

//////////////////////////////////////////////////////////////////////////////////////////////
/// \brief Transformation error function evaluator
//////////////////////////////////////////////////////////////////////////////////////////////
class TransformErrorEval : public ErrorEvaluator<6,6>::type
{
public:

  /// Convenience typedefs
  typedef boost::shared_ptr<TransformErrorEval> Ptr;
  typedef boost::shared_ptr<const TransformErrorEval> ConstPtr;

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Constructor - error is difference between 'T' and identity (in Lie algebra space)
  //////////////////////////////////////////////////////////////////////////////////////////////
  TransformErrorEval(const se3::TransformEvaluator::ConstPtr& T);

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Convenience constructor - error between meas_T_21 and T_21
  //////////////////////////////////////////////////////////////////////////////////////////////
  TransformErrorEval(const lgmath::se3::Transformation& meas_T_21,
                     const se3::TransformEvaluator::ConstPtr& T_21);

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Convenience constructor - error between meas_T_21 and T_20*inv(T_10)
  //////////////////////////////////////////////////////////////////////////////////////////////
  TransformErrorEval(const lgmath::se3::Transformation& meas_T_21,
                     const se3::TransformStateVar::Ptr& T_20,
                     const se3::TransformStateVar::Ptr& T_10);

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Returns whether or not an evaluator contains unlocked state variables
  //////////////////////////////////////////////////////////////////////////////////////////////
  virtual bool isActive() const;

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Evaluate the 6-d measurement error
  //////////////////////////////////////////////////////////////////////////////////////////////
  virtual Eigen::Matrix<double,6,1> evaluate() const;

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Evaluate the 6-d measurement error and Jacobians
  //////////////////////////////////////////////////////////////////////////////////////////////
  virtual Eigen::Matrix<double,6,1> evaluate(const Eigen::Matrix<double,6,6>& lhs,
                                             std::vector<Jacobian<6,6> >* jacs) const;

private:

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Error evaluator
  //////////////////////////////////////////////////////////////////////////////////////////////
  se3::LogMapEvaluator::ConstPtr errorEvaluator_;
};

} // steam

#endif // STEAM_TRANSFORM_ERROR_EVALUATOR_HPP
